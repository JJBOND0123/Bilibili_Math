{% extends "base.html" %}

{% block head %}
<link href="{{ url_for('static', filename='css/profile.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="top-area-card text-center">
            <img id="profile-avatar" src="" class="user-avatar mx-auto mb-3"
                onerror="this.src='{{ url_for('static', filename='img/default-avatar.svg') }}'">
            <div class="user-name" id="user-name">...</div>
            <div class="user-sign mb-3" id="user-desc">...</div>
            <button class="btn-edit-mini" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                <i class="far fa-edit"></i> 编辑资料
            </button>
        </div>
    </div>

    <div class="col-md-9">
        <div class="top-area-card">
            <div class="stats-row">
                <div class="stat-item stat-clickable"
                    onclick="switchTab('fav-pane', document.querySelectorAll('.bili-tab-item')[0])">
                    <div class="stat-num num-pink" id="stat-fav-count">-</div>
                    <div class="stat-label">收藏视频</div>
                </div>
                <div class="stat-item stat-clickable"
                    onclick="switchTab('history-pane', document.querySelectorAll('.bili-tab-item')[1])">
                    <div class="stat-num stat-num-orange" id="stat-history-count">-</div>
                    <div class="stat-label">学习足迹</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bili-tabs">
    <div class="bili-tab-item active" onclick="switchTab('fav-pane', this)">我的收藏</div>
    <div class="bili-tab-item" onclick="switchTab('history-pane', this)">学习足迹</div>
</div>

<div class="tab-content">
    <div class="tab-pane fade show active" id="fav-pane">
        <div class="row g-3" id="fav-grid"></div>
    </div>
    <div class="tab-pane fade" id="history-pane">
        <div class="row g-3" id="history-grid"></div>
    </div>
</div>

<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-rounded">
            <div class="modal-header modal-header-divider">
                <h6 class="modal-title modal-title-strong">编辑资料</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modal-body-padding">
                <form id="editForm">
                    <div class="mb-3 text-center">
                        <label for="input-avatar" class="avatar-upload">
                            <img id="preview-avatar" src=""
                                onerror="this.src='{{ url_for('static', filename='img/default-avatar.svg') }}'">
                            <div class="change-avatar-text">更换头像</div>
                        </label>
                        <input type="file" class="d-none" id="input-avatar" accept="image/*"
                            onchange="previewImage(this)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label form-label-muted">昵称</label>
                        <input type="text" class="form-control input-height-36" id="input-username" placeholder="请输入昵称">
                    </div>
                    <div class="mb-3">
                        <label class="form-label form-label-muted">个性签名</label>
                        <input type="text" class="form-control input-height-36" id="input-desc" placeholder="欢迎新同学！"
                            maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label form-label-muted">邮箱账号</label>
                        <input type="email" class="form-control input-readonly" id="input-account" readonly>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer-divider">
                <button type="button" class="btn btn-sm btn-danger-outline" onclick="deleteAccount()">注销账号</button>
                <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-sm btn-primary-solid" onclick="saveProfile()">保存</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function switchTab(targetId, btn) {
        $('.bili-tab-item').removeClass('active');
        $(btn).addClass('active');
        $('.tab-pane').removeClass('show active');
        setTimeout(() => { $('#' + targetId).addClass('show active'); }, 50);
    }

    const DEFAULT_AVATAR = "{{ url_for('static', filename='img/default-avatar.svg') }}";

    function loadProfile() {
        if (window.showSkeleton) {
            window.showSkeleton($('#fav-grid'), 4, 'col-lg-3 col-md-4 col-sm-6');
            window.showSkeleton($('#history-grid'), 4, 'col-lg-3 col-md-4 col-sm-6');
        } else {
            $('#fav-grid, #history-grid').html('<div class="col-12 text-center py-5 text-muted">加载中...</div>');
        }

        $.get('/api/user_profile', function (data) {
            let info = data.user_info;
            const nickname = info.username || '未设置昵称';
            $('#user-name').text(nickname);
            $('#user-desc').text(info.description || '欢迎新同学！！！');
            let avatar = info.avatar || DEFAULT_AVATAR;
            $('#profile-avatar').attr('src', avatar);
            $('#preview-avatar').attr('src', avatar);
            $('#input-account').val(info.account || '');
            $('#input-username').val(info.username);
            $('#input-desc').val(info.description);

            animateValue('stat-fav-count', 0, data.favorites.length, 800);
            const historyTotal = (typeof data.history_total === 'number' && Number.isFinite(data.history_total))
                ? data.history_total
                : (data.history || []).length;
            animateValue('stat-history-count', 0, historyTotal, 800);

            renderGrid(data.favorites, $('#fav-grid'), 'fav');
            renderGrid(data.history, $('#history-grid'), 'history');
        });
    }

    function animateValue(id, start, end, duration) {
        const el = document.getElementById(id);
        if (!el) return;

        const from = Number(start) || 0;
        const to = Number(end) || 0;
        const ms = Math.max(0, Number(duration) || 0);
        const range = to - from;

        if (range === 0 || ms === 0) {
            el.textContent = String(to);
            return;
        }

        const minTimer = 50;
        const stepTime = Math.max(Math.floor(ms / Math.abs(range)), minTimer);
        const startTime = Date.now();
        const endTime = startTime + ms;

        const timer = setInterval(() => {
            const now = Date.now();
            const remaining = Math.max((endTime - now) / ms, 0);
            const value = Math.round(to - remaining * range);
            el.textContent = String(value);
            if (value === to) clearInterval(timer);
        }, stepTime);

        el.textContent = String(from);
    }

    function renderGrid(list, $container, type) {
        if (!$container || !$container.length) return;
        if (!list || list.length === 0) { $container.html(emptyState()); return; }
        if (!window.renderVideoGrid) return;

        window.renderVideoGrid(list, $container, {
            colClass: 'col-lg-3 col-md-4 col-sm-6',
            cardOptions: (v) => ({
                dateText: type === 'history' ? (v.action_time || '最近') : undefined,
                actionHtml: type === 'fav'
                    ? window.renderRemoveButton(v.bvid, 'fav', '取消收藏', 'fas fa-heart-broken')
                    : type === 'history'
                        ? window.renderRemoveButton(v.bvid, 'history', '删除记录', 'fas fa-trash-alt')
                        : ''
            })
        });
    }

    function emptyState() {
        return `<div class="col-12 text-center py-5 text-muted">
            <div class="empty-icon"><i class="fas fa-wind"></i></div>
            <p class="small">这里空空如也~</p>
        </div>`;
    }

    function removeAction(bvid, type) {
        if (!confirm("确定要移除吗?")) return;

        $.ajax({
            url: '/api/remove_action', type: 'POST', contentType: 'application/json', data: JSON.stringify({ bvid: bvid, type: type }),
            success: function () {
                window.showToast && window.showToast('删除成功', 'success');
                loadProfile();
            }
        });
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) { $('#preview-avatar').attr('src', e.target.result); }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function saveProfile() {
        let formData = new FormData();
        formData.append('username', $('#input-username').val());
        formData.append('description', $('#input-desc').val());
        let file = $('#input-avatar')[0].files[0];
        if (file) formData.append('avatar', file);

        $.ajax({
            url: '/api/update_profile', type: 'POST', data: formData, processData: false, contentType: false,
            success: function () {
                bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                window.showToast && window.showToast('个人资料已更新', 'success');
                loadProfile();
            }
        });
    }

    function deleteAccount() {
        if (!confirm('此操作不可恢复，确定要注销账号吗？')) return;
        if (!confirm('请再次确认要注销账号。')) return;

        $.ajax({
            url: '/api/delete_account', type: 'POST',
            success: function () {
                window.showToast && window.showToast('账号已注销', 'success');
                setTimeout(() => { window.location.href = '/logout'; }, 1500);
            }
        });
    }

    $(document).ready(function () { loadProfile(); });
</script>
{% endblock %}