{% extends "base.html" %}

{% block head %}
<link href="{{ url_for('static', filename='css/recommend.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="sort-bar">
    <button class="btn-filter active" type="button">
        <i class="fas fa-star me-1"></i>为你推荐
    </button>
    <button class="btn-filter secondary" id="refreshBtn" type="button" title="换一批">
        <i class="fas fa-rotate me-1"></i>换一批
    </button>
</div>

<div class="row g-4" id="video-grid">
    <div class="col-12 text-center mt-5">
        <div class="spinner-border text-primary opacity-50" role="status"></div>
        <p class="mt-3 text-muted">正在为你推荐...</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let state = { limit: 8, q: '' };

    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const q = urlParams.get('q');
        if (q) { state.q = q; $('#global-search-input').val(q); }

        $('#refreshBtn').on('click', function () {
            fetchVideos();
        });

        fetchVideos();
    });

    function fetchVideos() {
        if (window.showSkeleton) {
            window.showSkeleton($('#video-grid'), state.limit, 'col-lg-3 col-md-4 col-sm-6');
        } else {
            $('#video-grid').html('<div class="col-12 text-center mt-5"><div class="spinner-border text-secondary opacity-25"></div></div>');
        }

        $.get('/api/personal_resources', { ...state, seed: Date.now() }, function (res) {
            if (window.renderVideoGrid) {
                window.renderVideoGrid(res.videos, $('#video-grid'), { colClass: 'col-lg-3 col-md-4 col-sm-6' });
            }
        }).fail(function () {
            $('#video-grid').html('<div class="col-12 text-center py-5"><div class="text-muted">推荐加载失败，请稍后重试</div></div>');
        });
    }
</script>
{% endblock %}