{% extends "base.html" %}

{% block head %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="nav-header mb-4">
    <div class="d-flex align-items-center gap-3">
        <h5 class="mb-0 fw-bold"><i class="fas fa-chart-network text-primary me-2"></i>数据仪表盘</h5>
        <div class="text-muted small border-start ps-3 d-none d-md-block">资源概览 · 榜单洞察 · 分布分析</div>
    </div>
    <div class="text-end bg-white px-3 py-2 rounded-pill shadow-sm">
        <span class="h5 fw-bold text-dark mb-0 font-monospace" id="clock">00:00:00</span>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 card-gradient-blue hover-up p-3">
            <div class="d-flex justify-content-between align-items-center text-white">
                <div>
                    <div class="opacity-75 small text-uppercase fw-bold">资源总数</div>
                    <div class="display-6 fw-bold" id="val-videos">-</div>
                </div>
                <i class="fas fa-database fa-3x opacity-25"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 card-gradient-orange hover-up p-3">
            <div class="d-flex justify-content-between align-items-center text-white">
                <div>
                    <div class="opacity-75 small text-uppercase fw-bold">累计热度</div>
                    <div class="display-6 fw-bold" id="val-views">-</div>
                </div>
                <i class="fas fa-fire fa-3x opacity-25"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 card-gradient-pink hover-up p-3">
            <div class="d-flex justify-content-between align-items-center text-white">
                <div>
                    <div class="opacity-75 small text-uppercase fw-bold">平均推荐得分</div>
                    <div class="display-6 fw-bold" id="val-score">-</div>
                </div>
                <i class="fas fa-star fa-3x opacity-25"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100 card-gradient-green hover-up p-3">
            <div class="d-flex justify-content-between align-items-center text-white">
                <div>
                    <div class="opacity-75 small text-uppercase fw-bold">入驻UP</div>
                    <div class="display-6 fw-bold" id="val-teachers">-</div>
                </div>
                <i class="fas fa-user-graduate fa-3x opacity-25"></i>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm h-100 rounded-4">
            <div class="card-header bg-transparent border-0 pt-4 ps-4">
                <h6 class="fw-bold text-dark"><i class="fas fa-crown text-warning me-2"></i>全站视频推荐得分榜 Top 8 <small
                        class="text-muted ms-2 fw-normal small-note">(点击跳转)</small></h6>
            </div>
            <div class="card-body">
                <div id="rankChart" class="chart-rank"></div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100 rounded-4">
            <div class="card-header bg-transparent border-0 pt-4 ps-4">
                <h6 class="fw-bold text-dark">
                    学科资源占比
                    <span class="badge bg-light text-secondary ms-2 border">
                        考研相关 <span id="val-exam-total">-</span> (<span id="val-exam-ratio">-</span>)
                    </span>
                </h6>
            </div>
            <div class="card-body">
                <div id="roseChart" class="chart-rose"></div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-12">
        <div class="card border-0 shadow-sm h-100 rounded-4">
            <div class="card-header bg-transparent border-0 pt-4 ps-4 d-flex align-items-center">
                <h6 class="fw-bold text-dark mb-0">视频性价比分析</h6>
                <span class="badge bg-light text-secondary ms-2 border">点击圆点可直接跳转观看</span>
            </div>
            <div class="card-body">
                <div id="scatterChart" class="chart-scatter"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

    $(document).ready(function () {
        $.get('/api/stats', function (res) {
            $('#val-videos').text(res.total_videos.toLocaleString());
            $('#val-views').text(window.formatCount ? window.formatCount(res.total_views) : res.total_views);
            $('#val-teachers').text(res.total_teachers);
            $('#val-score').text(res.avg_score);
            if (typeof res.exam_total === 'number') $('#val-exam-total').text(res.exam_total.toLocaleString());
            if (typeof res.exam_ratio === 'number') $('#val-exam-ratio').text((res.exam_ratio * 100).toFixed(1) + '%');

            initRankChart(res.rank_titles, res.rank_scores, res.rank_bvids);
            initRoseChart(res.category_data);
            initScatterChart(res.scatter_data);
        });
    });

    function initRankChart(titles, scores, bvids) {
        var chart = echarts.init(document.getElementById('rankChart'));
        chart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, formatter: '{b}: 推荐得分 {c}' },
            grid: { left: '3%', right: '8%', bottom: '3%', top: '3%', containLabel: true },
            xAxis: { type: 'value', splitLine: { show: false } },
            yAxis: {
                type: 'category', data: titles, triggerEvent: true,
                axisLabel: { interval: 0, fontWeight: 'bold', color: '#333', width: 120, overflow: 'truncate' },
                axisLine: { show: false }, axisTick: { show: false }
            },
            series: [{
                name: '推荐得分(0-100)', type: 'bar', data: scores, barWidth: '50%',
                itemStyle: { borderRadius: [0, 10, 10, 0], color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [{ offset: 0, color: '#00A1D6' }, { offset: 1, color: '#00F2FE' }]) },
                label: { show: true, position: 'right', fontWeight: 'bold', color: '#666' }
            }]
        });
        chart.on('click', function (params) {
            var bvid = null;
            if (params.componentType === 'series') bvid = bvids[params.dataIndex];
            else if (params.componentType === 'yAxis') {
                var index = titles.indexOf(params.value);
                if (index !== -1) bvid = bvids[index];
            }
            if (bvid) window.open('/go/' + encodeURIComponent(bvid), '_blank');
        });
        window.addEventListener('resize', () => chart.resize());
    }

    function initRoseChart(data) {
        var chart = echarts.init(document.getElementById('roseChart'));
        chart.setOption({
            tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
            legend: { top: 'bottom', icon: 'circle', type: 'scroll' },
            series: [{
                name: '资源分布',
                type: 'pie',
                radius: [20, 100],
                center: ['50%', '45%'],
                roseType: 'area',
                itemStyle: {
                    borderRadius: 5
                },
                data: data,
                color: ['#00A1D6', '#FB7299', '#FFC107', '#33CC99', '#975FE4', '#FF6699', '#23ADE5']
            }]
        });
        window.addEventListener('resize', () => chart.resize());
    }

    function initScatterChart(data) {
        var chart = echarts.init(document.getElementById('scatterChart'));
        chart.setOption({
            tooltip: {
                trigger: 'item',
                backgroundColor: 'rgba(255,255,255,0.95)',
                textStyle: { color: '#333' },
                formatter: function (params) {
                    return `<div class="tooltip-left">
                            <span class="tooltip-up">${params.data[3]}</span><br/>
                            ${params.data[2]}<br/>
                            时长: <b>${params.data[0]}</b> 分<br/>
                            推荐得分: <b>${params.data[1]}</b> (0-100)
                            </div>`;
                }
            },
            grid: { left: '5%', right: '5%', bottom: '10%', top: '10%' },
            xAxis: { name: '时长(分)', type: 'value', splitLine: { lineStyle: { type: 'dashed' } } },
            yAxis: { name: '推荐得分(0-100)', type: 'value', splitLine: { lineStyle: { type: 'dashed' } } },
            series: [{
                symbolSize: 10,
                data: data,
                type: 'scatter',
                cursor: 'pointer',
                itemStyle: {
                    color: function (params) {
                        return params.data[1] > 70 ? '#FB7299' : (params.data[1] > 50 ? '#00A1D6' : '#aaa');
                    },
                    opacity: 0.7,
                    shadowBlur: 5,
                    shadowColor: 'rgba(0,0,0,0.2)'
                }
            }]
        });
        chart.on('click', function (params) {
            var bvid = params.data[4];
            if (bvid) window.open('/go/' + encodeURIComponent(bvid), '_blank');
        });
        window.addEventListener('resize', () => chart.resize());
    }
</script>
{% endblock %}